%%{init: {'theme': 'base', 'gitGraph': {'showCommitLabel': true}, 'flowchart': {'rankdir': 'TB'}} }%%
graph TD
    %% Definicija izgleda grafa
    classDef default fill:#f9f,stroke:#333,stroke-width:2px;
    classDef register fill:#fff,stroke:#000,stroke-width:1px;

    %% Definicija stanja
    IDLE[IDLE]:::doublecircle;
    PRIMI_PAKET[PRIMI_PAKET];
    POSALJI_CELIJU[POSALJI_CELIJU];
    CEKAJ_READY[CEKAJ_READY];
    PADDING[PADDING];

    %% Tranzicije između stanja
    IDLE -->|sink_sop| PRIMI_PAKET
    PRIMI_PAKET -->|sink_eop| POSALJI_CELIJU
    PRIMI_PAKET -->|!source_ready| CEKAJ_READY
    POSALJI_CELIJU -->|!last_cell & source_ready| PRIMI_PAKET
    POSALJI_CELIJU -->|!source_ready| CEKAJ_READY
    POSALJI_CELIJU -->|last_cell & source_ready| PADDING
    PADDING -->|padding_done & source_ready| IDLE
    PADDING -->|!source_ready| CEKAJ_READY
    CEKAJ_READY -->|source_ready| POSALJI_CELIJU

    %% Sekvencijalna logika
    registri("state <= next_state\npadding_count <= padding_next\ndata_buffer <= data_buffer_next\ncell_size <= constant\nsource_valid = (state == POSALJI_CELIJU or state == PADDING)\nsource_sop = (state == POSALJI_CELIJU and data_buffer == initial_data_size)\nsource_eop = (state == PADDING)\nsource_data = data_buffer[0:cell_size]\nsink_ready = (state == IDLE or state == PRIMI_PAKET)\npadding_done = (padding_count == 0)\nlast_cell = (data_buffer <= cell_size)"):::circle

    %% Clock, Reset, and Enable
    clk_rst["clk\nreset\nenable"]:::diamond

    %% Connections between processes
    clk_rst -->|dotted| registri

    %% Assumptions
    assumptions["Pretpostavke:\n- Podaci se primaju putem 'sink' interfejsa.\n- Podaci se šalju putem 'source' interfejsa.\n- 'cell_size' je konstanta.\n- 'initial_data_size' je početna veličina paketa podataka.\n- data_buffer mora biti dovoljno velik da primi cijeli paket podataka.\n- Padding se dodaje kako bi ukupna veličina podataka bila višekratnik od 'cell_size' (Zero Padding).\n- FSM se resetuje u IDLE stanje kada se reset aktivira.\n- Backpressure se kontroliše pomoću source_ready i sink_ready signala."]:::note
